<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Отправитель отчётов</title>
  <style>
    :root{
      --primary:#560087; --bg:#f7f7f8; --text:#111; --muted:#6a6a6a; --stroke:#e9e9ee;
      --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:560px;margin:0 auto;padding:calc(env(safe-area-inset-top) + 12px) 14px calc(env(safe-area-inset-bottom) + 18px)}

    /* Tabs */
    .tabs{display:flex;gap:10px;margin:4px 0 14px}
    .tab{flex:1;border:1px solid var(--stroke);background:#fff;border-radius:999px;padding:10px 12px;
      text-align:center;font-weight:800;font-size:14px;transition:.18s ease;box-shadow:0 2px 10px rgba(0,0,0,.02)}
    .tab:hover{transform:translateY(-1px)}
    .tab.active{color:#fff;background:var(--primary);border-color:var(--primary);box-shadow:0 8px 20px rgba(86,0,135,.18)}

    .topbar{display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:14px;align-items:center}
    .btn-ghost{border:1.5px solid var(--primary);color:var(--primary);background:#fff;padding:10px 14px;border-radius:999px;
      font-weight:800;box-shadow:0 8px 18px rgba(86,0,135,.12);transition:.18s ease}
    .btn-ghost:hover{transform:translateY(-1px)}

    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    h1{margin:0 0 10px;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px}

    label{display:block;font-size:13px;color:#444;margin:14px 0 6px}
    input,select,textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--stroke);background:#fff;font-size:16px;outline:none;
      transition:border-color .15s ease, box-shadow .15s ease}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(86,0,135,.14)}
    textarea{min-height:88px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .hidden{display:none!important}

    /* SEND button with animations */
    .btn{position:relative;overflow:hidden;margin-top:16px;width:100%;border:0;border-radius:14px;
      background:var(--primary);color:#fff;padding:14px 16px;font-size:16px;font-weight:800;
      box-shadow:0 10px 22px rgba(86,0,135,.22);cursor:pointer;transition:transform .15s ease, box-shadow .15s ease}
    .btn:hover{animation:pulse 1.3s infinite}
    .btn:active{transform:translateY(1px)}
    @keyframes pulse{0%{box-shadow:0 10px 22px rgba(86,0,135,.22)}50%{box-shadow:0 14px 28px rgba(86,0,135,.3)}100%{box-shadow:0 10px 22px rgba(86,0,135,.22)}}
    .btn .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(255,255,255,.35);animation:ripple .6s linear}
    @keyframes ripple{to{transform:scale(4);opacity:0}}
    .btn.loading{pointer-events:none;opacity:.9;animation:none}
    .btn.loading .btn-text{opacity:0}
    .btn .spinner{position:absolute;inset:0;display:none;align-items:center;justify-content:center}
    .btn.loading .spinner{display:flex}
    .spin{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,.45);border-top-color:#fff;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .note{font-size:12px;color:var(--muted);margin-top:10px;text-align:center}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom) + 14px);
      background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;box-shadow:var(--shadow);
      opacity:0;pointer-events:none;transition:opacity .25s ease}
    .toast.show{opacity:1}

    /* ======= Касса · Склад ======= */
    .row-2{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-bottom:10px}
    /* Обновить: прячем текст и показываем спиннер по центру */
    .btn-refresh{position:relative;display:inline-flex;align-items:center;justify-content:center;min-width:130px;border:1.5px solid var(--primary);color:var(--primary);background:#fff;padding:10px 16px;border-radius:999px;font-weight:800;letter-spacing:.2px;box-shadow:0 8px 18px rgba(86,0,135,.12);transition:.18s ease}
    .btn-refresh:hover{transform:translateY(-1px)}
    .btn-refresh .txt{transition:opacity .15s ease}
    .btn-refresh .spin2{display:none;position:absolute;left:50%;top:50%;width:18px;height:18px;margin:-9px 0 0 -9px;border:2px solid rgba(86,0,135,.35);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
    .btn-refresh.loading{pointer-events:none;opacity:.95}
    .btn-refresh.loading .txt{opacity:0}
    .btn-refresh.loading .spin2{display:block}

    .seg{display:grid;grid-template-columns:1fr 1fr;background:#f2eef5;border:1px solid #e7dff1;border-radius:12px;padding:4px;margin-bottom:12px}
    .seg button{border:0;background:transparent;padding:10px 8px;border-radius:10px;font-weight:800;color:#3d3d3d;transition:.18s}
    .seg button.active{background:var(--primary);color:#fff;box-shadow:0 6px 16px rgba(86,0,135,.18)}
    .seg button:not(.active):hover{background:#fff}

    .cash-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end;margin-top:18px}
    .cash-label{font-weight:800;font-size:18px}
    .cash-amount{font-weight:900;font-size:34px;line-height:1}

    /* ======= Склад: строки с разделительными линиями ======= */
    .list{display:flex;flex-direction:column;margin-top:4px}
    .item{display:grid;grid-template-columns:1fr auto;align-items:center;padding:12px 0;border-bottom:1px solid #e3e3ea}
    .list .item:first-child{border-top:1px solid #e3e3ea}
    .name{font-size:15px}
    .qty{font-weight:800;font-size:18px;line-height:1}

    /* Skeletons (shimmer) */
    .skel{position:relative; overflow:hidden; background:#eee; border-radius:10px}
    .skel::after{content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.6), rgba(255,255,255,0));
      animation:shimmer 1.1s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
    .skel-line{height:14px; width:60%}
    .skel-amount{height:34px; width:120px; border-radius:8px}
    .skel-item{display:grid; grid-template-columns:1fr 80px; gap:12px; align-items:center; padding:12px 0; border-bottom:1px solid #eee}
    .skel-item:first-child{border-top:1px solid #eee}
    .skel-name{height:16px; width:70%}
    .skel-qty{height:18px; width:40px; justify-self:end; border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LOGIN VIEW -->
    <div id="loginView" class="card center hidden" style="display:flex;min-height:70vh;align-items:center">
      <div style="width:100%">
        <div class="brand" style="font-weight:900;font-size:22px;margin-bottom:8px">Вход</div>
        <div class="muted" style="color:var(--muted);font-size:13px;margin-bottom:10px">ҶДММ “Тибби Ҷаҳон”</div>

        <label>Логин</label>
        <input id="login" type="text" placeholder="Введите свой логин" autocomplete="username" />

        <label>Пароль</label>
        <input id="password" type="password" placeholder="Введите свой пароль" autocomplete="current-password" />

        <button id="loginBtn" class="btn" style="margin-top:18px">
          <span class="btn-text">Войти</span>
          <span class="spinner"><span class="spin"></span></span>
        </button>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="appView" class="hidden">
      <div class="topbar">
        <div class="tabs">
          <div id="tabReport" class="tab active">Отправка отчёта</div>
          <div id="tabView" class="tab">Касса · Склад</div>
        </div>
        <button id="logoutBtn" class="btn-ghost">Выход</button>
      </div>

      <!-- Вкладка 1: Отправка -->
      <div id="viewReport" class="card">
        <h1>Отправитель отчётов</h1>

        <label>Ваше имя</label>
        <input id="author" type="text" placeholder="Эркинов Манастерак" autocomplete="name" />

        <label>Раздел</label>
        <select id="mode">
          <option value="finance">Финансы</option>
          <option value="products">Продукты</option>
        </select>

        <div id="opBlock">
          <label>Операция</label>
          <select id="operation"></select>
        </div>

        <div id="productBlock" class="hidden">
          <label>Продукт</label>
          <select id="product"></select>
        </div>

        <div class="row">
          <div>
            <label>Количество / Сумма</label>
            <input id="amount" type="number" inputmode="decimal" min="0" step="0.01" placeholder="Напр. 150" />
          </div>
          <div>
            <label>Дата</label>
            <input id="date" type="date" />
          </div>
        </div>

        <label>Комментарий</label>
        <textarea id="comment" placeholder="Коротко о сути операции..."></textarea>

        <button id="sendBtn" class="btn">
          <span class="btn-text">Отправить</span>
          <span class="spinner"><span class="spin"></span></span>
        </button>
      </div>

      <!-- Вкладка 2: Касса / Склад -->
      <div id="viewKS" class="card hidden">
        <div class="row-2">
          <h1 style="margin:0">Касса · Склад</h1>
          <button id="refreshBtn" class="btn-refresh">
            <span class="txt">Обновить</span>
            <span class="spin2" aria-hidden="true"></span>
          </button>
        </div>

        <div class="seg">
          <button id="btnCash" class="active">Касса</button>
          <button id="btnStock">Склад</button>
        </div>

        <!-- CASH -->
        <div id="cashBox">
          <div class="cash-row">
            <div class="cash-label">Сумма в кассе</div>
            <div class="cash-amount" id="cashAmt">—</div>
          </div>
          <!-- loader for cash -->
          <div id="cashSkel" class="cash-row hidden" aria-hidden="true">
            <div class="skel skel-line"></div>
            <div class="skel skel-amount"></div>
          </div>
        </div>

        <!-- STOCK -->
        <div id="stockBox" class="hidden">
          <div class="sub" style="margin-bottom:0">Остатки по складу</div>
          <div id="stockList" class="list"></div>
          <!-- skeleton list -->
          <div id="stockSkel" class="list hidden" aria-hidden="true"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Готово</div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw7FA-ARHxoqamhM1AOANwEGlvXS15kBiRRq8EEBRjPLNjjUnqtM5sf9wxHL9f7jKDLXQ/exec";

    const $ = (id) => document.getElementById(id);
    const toast = (msg) => { const t=$('toast'); t.textContent = msg; t.className='toast show'; setTimeout(()=>t.className='toast', 2000); };

    /* Ripple helper */
    function addRipple(btn){
      btn.addEventListener('click', (e)=>{
        const circle=document.createElement('span'); const d=Math.max(btn.clientWidth,btn.clientHeight);
        circle.style.width=circle.style.height=d+'px';
        const rect=btn.getBoundingClientRect();
        circle.style.left=(e.clientX-rect.left - d/2)+'px';
        circle.style.top=(e.clientY-rect.top - d/2)+'px';
        circle.className='ripple';
        const old=btn.getElementsByClassName('ripple')[0]; if(old) old.remove();
        btn.appendChild(circle);
      }, {passive:true});
    }

    /* Tabs */
    function showTab(which){
      const r=$('viewReport'), k=$('viewKS'), tr=$('tabReport'), tv=$('tabView');
      if(which==='report'){ r.classList.remove('hidden'); k.classList.add('hidden'); tr.classList.add('active'); tv.classList.remove('active'); }
      else{ r.classList.add('hidden'); k.classList.remove('hidden'); tr.classList.remove('active'); tv.classList.add('active'); }
    }
    function bindTabs(){ $('tabReport').onclick=()=>showTab('report'); $('tabView').onclick=()=>{ showTab('ks'); showCash(); }; }

    /* Operations */
    const OPS={ finance:[{v:'Приход',t:'Приход'},{v:'Расход',t:'Расход'}], products:[{v:'Приход',t:'Приход'},{v:'Выдача',t:'Выдача'}] };
    function fillOps(mode){ const el=$('operation'); el.innerHTML=''; OPS[mode].forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v; opt.textContent=o.t; el.appendChild(opt); }); }
    function setToday(){ const d=new Date(), pad=n=>String(n).padStart(2,'0'); $('date').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function toggleBlocks(){ const mode=$('mode').value; $('productBlock').classList.toggle('hidden',mode!=='products'); fillOps(mode); if(mode==='products') loadProductsNames(); }

    /* Local storage name */
    function persistAuthor(){ localStorage.setItem('report_author',$('author').value.trim()); }
    function restoreAuthor(){ const a=localStorage.getItem('report_author'); if(a) $('author').value=a; }
    function bindAuthorAutosave(){ ['input','blur','change'].forEach(ev=>$('author').addEventListener(ev,persistAuthor)); }

    /* Auth */
    function setSession(session){ localStorage.setItem('session', JSON.stringify(session)); }
    function getSession(){ try{ return JSON.parse(localStorage.getItem('session')||''); } catch { return null; } }
    function clearSession(){ localStorage.removeItem('session'); }

    async function doLogin(){
      const login=$('login').value.trim(), password=$('password').value;
      if(!login || !password){ toast('Введите логин и пароль'); return; }
      const btn=$('loginBtn'); btn.classList.add('loading'); btn.disabled=true;
      try{
        const res=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'login', login, password})});
        const data=await res.json();
        if(data && data.ok){
          setSession({login, name:data.name||''});
          enterApp(data.name || login);
        }else{ toast('Неверный логин или пароль'); }
      }catch(e){ console.error(e); toast('Ошибка входа'); }
      finally{ btn.classList.remove('loading'); btn.disabled=false; }
    }
    function logout(){ clearSession(); $('appView').classList.add('hidden'); $('loginView').classList.remove('hidden'); }

    function enterApp(nameOrLogin){
      $('loginView').classList.add('hidden'); $('appView').classList.remove('hidden');
      bindTabs(); bindAuthorAutosave(); restoreAuthor(); if(!$('author').value){ $('author').value = nameOrLogin || ''; }
      fillOps('finance'); setToday(); showTab('report');
      $('mode').addEventListener('change',toggleBlocks);
      $('sendBtn').addEventListener('click',send); addRipple($('sendBtn'));
      $('btnCash').onclick=showCash; $('btnStock').onclick=showStock;
      $('refreshBtn').onclick=onRefreshClick;  // с анимацией и тостом
      showCash();
      $('logoutBtn').onclick=logout;
    }

    addRipple($('loginBtn'));
    $('loginBtn').addEventListener('click', doLogin);

    // авто-вход
    (function initAuth(){ const s=getSession(); if(s && (s.login||s.name)){ enterApp(s.name || s.login); } else { $('loginView').classList.remove('hidden'); } })();

    /* Loaders helpers */
    function setCashLoading(on){ $('cashAmt').classList.toggle('hidden', on); $('cashSkel').classList.toggle('hidden', !on); }
    function setStockLoading(on){
      const sk=$('stockSkel'); sk.classList.toggle('hidden', !on);
      if(on && !sk.hasChildNodes()){
        for(let i=0;i<5;i++){
          const row=document.createElement('div'); row.className='skel-item';
          const n=document.createElement('div'); n.className='skel skel-name';
          const q=document.createElement('div'); q.className='skel skel-qty';
          row.appendChild(n); row.appendChild(q); sk.appendChild(row);
        }
      }
    }

    /* API */
    async function loadProductsNames(){
      try{
        const res=await fetch(SCRIPT_URL+'?action=products'); const data=await res.json();
        const list=Array.isArray(data.products)?data.products:[]; const el=$('product'); el.innerHTML='';
        list.forEach(name=>{ const opt=document.createElement('option'); opt.value=name; opt.textContent=name; el.appendChild(opt); });
        if(!list.length){ const opt=document.createElement('option'); opt.textContent='(Список пуст)'; el.appendChild(opt); }
      }catch(err){ console.error(err); toast('Не удалось загрузить продукты'); }
    }

    async function loadCash(){
      try{
        setCashLoading(true);
        const res=await fetch(SCRIPT_URL+'?action=cash'); const data=await res.json();
        $('cashAmt').textContent = (data.amount!=null? data.amount : '—');
      }catch(err){ console.error(err); toast('Ошибка загрузки кассы'); }
      finally{ setCashLoading(false); }
    }

    async function loadStock(){
      try{
        setStockLoading(true);
        const res=await fetch(SCRIPT_URL+'?action=stock'); const data=await res.json();
        const list=Array.isArray(data.stock)?data.stock:[]; const box=$('stockList'); box.innerHTML='';
        if(!list.length){ box.innerHTML='<div class="hint">Пусто</div>'; return; }
        list.forEach(row=>{
          const item=document.createElement('div'); item.className='item';
          const name=document.createElement('div'); name.className='name'; name.textContent=row.name||'(без названия)';
          const qty=document.createElement('div'); qty.className='qty'; qty.textContent=(row.qty!=null?row.qty:'—');
          item.appendChild(name); item.appendChild(qty); box.appendChild(item);
        });
      }catch(err){ console.error(err); toast('Ошибка загрузки склада'); }
      finally{ setStockLoading(false); }
    }

    // segmented switch
    function showCash(){ $('btnCash').classList.add('active'); $('btnStock').classList.remove('active'); $('cashBox').classList.remove('hidden'); $('stockBox').classList.add('hidden'); loadCash(); }
    function showStock(){ $('btnCash').classList.remove('active'); $('btnStock').classList.add('active'); $('cashBox').classList.add('hidden'); $('stockBox').classList.remove('hidden'); loadStock(); }

    // refresh with animation + toast
    async function onRefreshClick(){
      const btn = $('refreshBtn'); btn.classList.add('loading');
      try{
        if(!$('cashBox').classList.contains('hidden')){ await loadCash(); }
        else { await loadStock(); }
        toast('Информация обновлена');
      } finally {
        btn.classList.remove('loading');
      }
    }

    /* Send */
    async function send(){
      const author=$('author').value.trim();
      const mode=$('mode').value, operation=$('operation').value;
      const amount=parseFloat(($('amount').value||'').replace(',','.'));
      const date=$('date').value, comment=$('comment').value.trim();
      const product=(mode==='products')?$('product').value:'';
      if(!author){ toast('Укажите имя'); return; }
      if(!(amount>0)){ toast('Укажите количество/сумму > 0'); return; }
      if(!date){ toast('Выберите дату'); return; }

      const payload={author,mode,operation,amount,date,comment,product};
      const btn=$('sendBtn'); btn.classList.add('loading'); btn.disabled=true;
      try{
        const res=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
        const data=await res.json();
        if(data && data.ok){ toast('Сохранено'); $('comment').value=''; $('amount').value=''; persistAuthor(); }
        else{ throw new Error(data && data.error || 'Ошибка'); }
      }catch(err){ console.error(err); toast('Ошибка сохранения'); }
      finally{ btn.classList.remove('loading'); btn.disabled=false; }
    }
  </script>
</body>
</html>
